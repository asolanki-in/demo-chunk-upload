#!/bin/bash

# Simple injection script for IPA
INPUT_IPA="$1"
OUTPUT_IPA="$2"

if [ $# -lt 2 ]; then
    echo "Usage: $0 <input.ipa> <output.ipa>"
    exit 1
fi

# Create temporary directory
TEMP_DIR="/tmp/ipa_inject_$$"
mkdir -p "$TEMP_DIR"

# Extract IPA
echo "Extracting IPA..."
unzip -q "$INPUT_IPA" -d "$TEMP_DIR"

# Find .app directory
APP_DIR=$(find "$TEMP_DIR" -name "*.app" -type d | head -1)
if [ -z "$APP_DIR" ]; then
    echo "Error: No .app found"
    exit 1
fi

APP_NAME=$(basename "$APP_DIR" .app)
EXECUTABLE="$APP_DIR/$APP_NAME"

# Copy framework
echo "Injecting framework..."
mkdir -p "$APP_DIR/Frameworks"
cp -r "BiometricBypass.framework" "$APP_DIR/Frameworks/"

# Use optool to inject
echo "Injecting load command..."
# Download optool if not exists
if [ ! -f "optool" ]; then
    echo "Downloading optool..."
    curl -L https://github.com/alexzielenski/optool/releases/download/0.1/optool.zip -o optool.zip
    unzip optool.zip
    chmod +x optool
fi

./optool install -c load -p "@executable_path/Frameworks/BiometricBypass.framework/BiometricBypass" -t "$EXECUTABLE"

# Package back to IPA
echo "Creating IPA..."
cd "$TEMP_DIR"
zip -qr "$OUTPUT_IPA" Payload/

echo "Injected IPA created: $OUTPUT_IPA"
echo "Note: You need to resign this IPA before installing!"
